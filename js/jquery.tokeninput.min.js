/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 * Modified for use in Project AR2 by Melvin Lee (http://www.zy.sg/)
 * 
 */
(function(a){var b={method:"GET",queryParam:"q",searchDelay:300,minChars:2,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:false,hintText:ar2Admin_l10n.hintText,noResultsText:ar2Admin_l10n.noResultsText,searchingText:ar2Admin_l10n.searchingText,deleteText:"Ã—",animateDropdown:true,theme:null,zindex:6e5,resultsLimit:null,resultsFormatter:function(a){return"<li>"+a[this.propertyToSearch]+"</li>"},tokenFormatter:function(a){return"<li><p>"+a[this.propertyToSearch]+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,tokenValue:"id",onResult:null,onAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:false};var c={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"};var d={BEFORE:0,AFTER:1,END:2};var e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};var f={init:function(c,d){var e=a.extend({},b,d||{});return this.each(function(){a(this).data("tokenInputObject",new a.TokenList(this,c,e))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(a){this.data("tokenInputObject").add(a);return this},remove:function(a){this.data("tokenInputObject").remove(a);return this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(a){this.data("tokenInputObject").toggleDisabled(a);return this},setLimit:function(a){this.data("tokenInputObject").setLimit(a);return this}};a.fn.tokenInput=function(a){if(f[a]){return f[a].apply(this,Array.prototype.slice.call(arguments,1))}else{return f.init.apply(this,arguments)}};a.TokenList=function(b,f,g){function x(b){if(typeof b==="boolean"){g.disabled=b}else{g.disabled=!g.disabled}n.prop("disabled",g.disabled);s.toggleClass(g.classes.disabled,g.disabled);if(p){E(a(p),d.END)}o.prop("disabled",g.disabled)}function y(){if(g.tokenLimit!==null&&j>=g.tokenLimit){n.hide();I();return}}function z(){if(m===(m=n.val())){return}var a=m.replace(/&/g,"&").replace(/\s/g," ").replace(/</g,"<").replace(/>/g,">");v.html(a);n.width(v.width()+30)}function A(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function B(b){var c=a(g.tokenFormatter(b));var d=b.readonly===true?true:false;if(d)c.addClass(g.classes.tokenReadOnly);c.addClass(g.classes.token).insertBefore(t);if(!d){a("<span>"+g.deleteText+"</span>").addClass(g.classes.tokenDelete).appendTo(c).click(function(){if(!g.disabled){G(a(this).parent());o.change();return false}})}var e=b;a.data(c.get(0),"tokeninput",b);i=i.slice(0,q).concat([e]).concat(i.slice(q));q++;H(i,o);j+=1;if(g.tokenLimit!==null&&j>=g.tokenLimit){n.hide();I()}return c}function C(b){var c=g.onAdd;if(j>0&&g.preventDuplicates){var d=null;s.children().each(function(){var c=a(this);var e=a.data(c.get(0),"tokeninput");if(e&&e.id===b.id){d=c;return false}});if(d){D(d);t.insertAfter(d);W(n);return}}if(g.tokenLimit==null||j<g.tokenLimit){B(b);y()}n.val("");I();if(a.isFunction(c)){c.call(o,b)}}function D(a){if(!g.disabled){a.addClass(g.classes.selectedToken);p=a.get(0);n.val("");I()}}function E(a,b){a.removeClass(g.classes.selectedToken);p=null;if(b===d.BEFORE){t.insertBefore(a);q--}else if(b===d.AFTER){t.insertAfter(a);q++}else{t.appendTo(s);q=j}W(n)}function F(b){var c=p;if(p){E(a(p),d.END)}if(c===b.get(0)){E(b,d.END)}else{D(b)}}function G(b){var c=a.data(b.get(0),"tokeninput");var d=g.onDelete;var e=b.prevAll().length;if(e>q)e--;b.remove();p=null;W(n);i=i.slice(0,e).concat(i.slice(e+1));if(e<q)q--;H(i,o);j-=1;if(g.tokenLimit!==null){n.show().val("");W(n)}if(a.isFunction(d)){d.call(o,c)}}function H(b,c){var d=a.map(b,function(a){if(typeof g.tokenValue=="function")return g.tokenValue.call(this,a);return a[g.tokenValue]});c.val(d.join(g.tokenDelimiter))}function I(){u.hide().empty();r=null}function J(){u.css({position:"absolute",top:a(s).offset().top+a(s).outerHeight(),left:a(s).offset().left,width:a(s).outerWidth(),"z-index":g.zindex}).show()}function K(){if(g.searchingText){u.html("<p>"+g.searchingText+"</p>");J()}}function L(){if(g.hintText){u.html("<p>"+g.hintText+"</p>");J()}}function N(a){return a.replace(M,"\\$&")}function O(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+N(b)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function P(a,b,c){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+N(b)+")(?![^<>]*>)(?![^&;]+;)","g"),O(b,c))}function Q(b,c){if(c&&c.length){u.empty();var d=a("<ul>").appendTo(u).mouseover(function(b){R(a(b.target).closest("li"))}).mousedown(function(b){C(a(b.target).closest("li").data("tokeninput"));o.change();return false}).hide();if(g.resultsLimit&&c.length>g.resultsLimit){c=c.slice(0,g.resultsLimit)}a.each(c,function(c,e){var f=g.resultsFormatter(e);f=P(f,e[g.propertyToSearch],b);f=a(f).appendTo(d);if(c%2){f.addClass(g.classes.dropdownItem)}else{f.addClass(g.classes.dropdownItem2)}if(c===0){R(f)}a.data(f.get(0),"tokeninput",e)});J();if(g.animateDropdown){d.slideDown("fast")}else{d.show()}}else{if(g.noResultsText){u.html("<p>"+g.noResultsText+"</p>");J()}}}function R(b){if(b){if(r){S(a(r))}b.addClass(g.classes.selectedDropdownItem);r=b.get(0)}}function S(a){a.removeClass(g.classes.selectedDropdownItem);r=null}function T(){var b=n.val();if(b&&b.length){if(p){E(a(p),d.AFTER)}if(b.length>=g.minChars){K();clearTimeout(l);l=setTimeout(function(){U(b)},g.searchDelay)}else{I()}}}function U(b){var c=b+V();var d=k.get(c);if(d){Q(b,d)}else{if(g.url){var e=V();var f={};f.data={};if(e.indexOf("?")>-1){var h=e.split("?");f.url=h[0];var i=h[1].split("&");a.each(i,function(a,b){var c=b.split("=");f.data[c[0]]=c[1]})}else{f.url=e}f.data["action"]=g.queryAction;f.data["limit"]=g.limit;f.data[g.queryParam]=b;f.type=g.method;f.dataType=g.contentType;if(g.crossDomain){f.dataType="jsonp"}f.success=function(d){if(a.isFunction(g.onResult)){d=g.onResult.call(o,d)}k.add(c,g.jsonContainer?d[g.jsonContainer]:d);if(n.val()===b){Q(b,g.jsonContainer?d[g.jsonContainer]:d)}};a.ajax(f)}else if(g.local_data){var j=a.grep(g.local_data,function(a){return a[g.propertyToSearch].toLowerCase().indexOf(b.toLowerCase())>-1});if(a.isFunction(g.onResult)){j=g.onResult.call(o,j)}k.add(c,j);Q(b,j)}}}function V(){var a=g.url;if(typeof g.url=="function"){a=g.url.call(g)}return a}function W(a){setTimeout(function(){a.focus()},50)}if(a.type(f)==="string"||a.type(f)==="function"){g.url=f;var h=V();if(g.crossDomain===undefined&&typeof h==="string"){if(h.indexOf("://")===-1){g.crossDomain=false}else{g.crossDomain=location.href.split(/\/+/g)[1]!==h.split(/\/+/g)[1]}}}else if(typeof f==="object"){g.local_data=f}if(g.classes){g.classes=a.extend({},c,g.classes)}else if(g.theme){g.classes={};a.each(c,function(a,b){g.classes[a]=b+"-"+g.theme})}else{g.classes=c}var i=[];var j=0;var k=new a.TokenList.Cache;var l;var m;var n=a('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",g.idPrefix+b.id).focus(function(){if(g.disabled){return false}else if(g.tokenLimit===null||g.tokenLimit!==j){L()}s.addClass(g.classes.focused)}).blur(function(){I();a(this).val("");s.removeClass(g.classes.focused)}).bind("keyup keydown blur update",z).keydown(function(b){var c;var f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!a(this).val()){c=t.prev();f=t.next();if(c.length&&c.get(0)===p||f.length&&f.get(0)===p){if(b.keyCode===e.LEFT||b.keyCode===e.UP){E(a(p),d.BEFORE)}else{E(a(p),d.AFTER)}}else if((b.keyCode===e.LEFT||b.keyCode===e.UP)&&c.length){D(a(c.get(0)))}else if((b.keyCode===e.RIGHT||b.keyCode===e.DOWN)&&f.length){D(a(f.get(0)))}}else{var g=null;if(b.keyCode===e.DOWN||b.keyCode===e.RIGHT){g=a(r).next()}else{g=a(r).prev()}if(g.length){R(g)}}return false;break;case e.BACKSPACE:c=t.prev();if(!a(this).val().length){if(p){G(a(p));o.change()}else if(c.length){D(a(c.get(0)))}return false}else if(a(this).val().length===1){I()}else{setTimeout(function(){T()},5)}break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(r){C(a(r).data("tokeninput"));o.change();return false}break;case e.ESCAPE:I();return true;default:if(String.fromCharCode(b.which)){setTimeout(function(){T()},5)}break}});var o=a(b).hide().val("").focus(function(){W(n)}).blur(function(){n.blur()});var p=null;var q=0;var r=null;var s=a("<ul />").addClass(g.classes.tokenList).click(function(b){var c=a(b.target).closest("li");if(c&&c.get(0)&&a.data(c.get(0),"tokeninput")){F(c)}else{if(p){E(a(p),d.END)}W(n)}}).mouseover(function(b){var c=a(b.target).closest("li");if(c&&p!==this){c.addClass(g.classes.highlightedToken)}}).mouseout(function(b){var c=a(b.target).closest("li");if(c&&p!==this){c.removeClass(g.classes.highlightedToken)}}).insertBefore(o);var t=a("<li />").addClass(g.classes.inputToken).appendTo(s).append(n);var u=a("<div>").addClass(g.classes.dropdown).appendTo("body").hide();var v=a("<tester/>").insertAfter(n).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:n.css("fontSize"),fontFamily:n.css("fontFamily"),fontWeight:n.css("fontWeight"),letterSpacing:n.css("letterSpacing"),whiteSpace:"nowrap"});o.val("");var w=g.prePopulate||o.data("pre");if(g.processPrePopulate&&a.isFunction(g.onResult)){w=g.onResult.call(o,w)}if(w&&w.length){a.each(w,function(a,b){B(b);y()})}if(g.disabled){x(true)}if(a.isFunction(g.onReady)){g.onReady.call()}this.setLimit=function(a){g.limit=a};this.clear=function(){s.children("li").each(function(){if(a(this).children("input").length===0){G(a(this))}})};this.add=function(a){C(a)};this.remove=function(b){s.children("li").each(function(){if(a(this).children("input").length===0){var c=a(this).data("tokeninput");var d=true;for(var e in b){if(b[e]!==c[e]){d=false;break}}if(d){G(a(this))}}})};this.getTokens=function(){return i};this.toggleDisabled=function(a){x(a)};var M=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g")};a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b);var d={};var e=0;var f=function(){d={};e=0};this.add=function(a,b){if(e>c.max_size){f()}if(!d[a]){e+=1}d[a]=b};this.get=function(a){return d[a]}}})(jQuery)